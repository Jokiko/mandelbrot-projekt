<html>
   <head>
      <meta charset="UTF-8">
	  <title>Test Client</title>
   </head>
   <body>
      <script>
		
		//Variablen fuer Berechnung der Mandelbrotmenge
		var width;
		var height;
		var anzClients;
		var myNumber;
		var iterations;
	  
		//Import der Faktorisierungsfunktion aus dem WebAssembly Modul
		let factorial;
		fetch("factorial.wasm")
		.then(bytes => bytes.arrayBuffer())
		.then(mod => WebAssembly.compile(mod))
		.then(module => {return new WebAssembly.Instance(module) })
		.then(instance => {
			factorial = instance.exports._Z4facti;
		});
	  
		//WebSocket Objekt zum Verbindungsaufbau zur IP/URL, WebSocket hat geringe Latenz
		var socket = new WebSocket('ws://localhost:5000');
		//var socket = new WebSocket('ws://136.199.4.88:5000');
	  
		//Funktion bei Verbindungsaufbau
		socket.onopen = function (){
			console.log("Verbindung aufgebaut.\n");
			//Sendet Server Nachricht
			for (i = 0; i < 1; i++) { 
			//socket.send("Ping\n"); 
			socket.send("type/.../WebSocket");
			socket.send("connect/.../abc");
			}
		};
		
		//Log bei Fehler
		socket.onerror = function (error){
			console.log("WebSocket Error " + error);
		};
		
		//callback-Funktion wird gerufen, wenn eine neue Websocket-Nachricht eintrifft
		socket.onmessage = function (messageEvent){
			console.log("Erhalte Nachricht von Server: " + messageEvent.data);
			//console.log("${messageEvent.data}\n");
			//socket.send(messageEvent.data.toUpperCase());
			var str = messageEvent.data;
			var res = str.split("/.../");
			//Uebermittlung der Gesamtanzahl an Clients
			if(res[0] === "anzRunning"){
				anzClients = res[1];
				console.log("Anzahl an Clients: " + anzClients);
			}
			//Uebermittlung der Client-Nummer
			if(res[0] === "yourNumber"){
				myNumber = res[1];
				console.log("Ich bin Client Nr. " + myNumber);
			}
			//Uebermittlung der Iterationsanzahl
			if(res[0] === "iterations"){
				iterations = res[1];
				console.log("Anzahl der Iterationen: " + iterations);
			}
			//Uebermittlung der Groesse des zu berechnenden Anteils, damit kann Berechnung beginnen
			if(res[0] === "size"){
				width = res[1];
				height = res[2];
				console.log("Erhalte Groesse: " + width + "x" + height);
				//Timing vorher
				var t0 = performance.now();
				var fact = factorial(width);
				//Berechnung Mandelbrotmenge
				for(var y = 0; y < height; y++){
					for(var x = 0; x < width; x++){
						//Rueckgabe itr Wert
						// TO-DO: Mandelbrotberechnung
						var erg = 0;
						socket.send("plot/.../"+x+"/.../"+y+"/.../"+erg);
					}
				}
				//Timing nachher
				var t1 = performance.now();
				console.log("Schicke Faktor von " + width + " zurueck an Server: " + fact);
				console.log("Berechnung dauerte " + (t1 - t0) + " Millisekunden.");
				socket.send(fact.valueOf());
			}
		};
		
		socket.onclose = function(closeEvent){
			if (closeEvent.wasClean){
				console.log("Verbindung beendet, code = ${closeEvent.code}, Grund = ${closeEvent.reason}");
			}
			else{
				console.log("Verbindung abgestuertzt.");
			}
		
		}
	  </script>
   </body>
</html>