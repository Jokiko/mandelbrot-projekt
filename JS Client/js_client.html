<html>
   <head>
      <meta charset="UTF-8">
	  <title>Test Client</title>
   </head>
   <body>
      <script>
		
		//Variablen fuer Berechnung der Mandelbrotmenge
		var width;
		var height;
		var anzClients;
		var myNumber;
	  
		//Import der Faktorisierungsfunktion aus dem WebAssembly Modul
		let factorial;
		fetch("factorial.wasm")
		.then(bytes => bytes.arrayBuffer())
		.then(mod => WebAssembly.compile(mod))
		.then(module => {return new WebAssembly.Instance(module) })
		.then(instance => {
			factorial = instance.exports._Z4facti;
		});
	  
		//WebSocket Objekt zum Verbindungsaufbau zur IP/URL, WebSocket hat geringe Latenz
		var socket = new WebSocket('ws://localhost:80');
	  
		//Funktion bei Verbindungsaufbau
		socket.onopen = function (){
			console.log("Verbindung aufgebaut.\n");
			//Sendet Server Nachricht
			for (i = 0; i < 1; i++) { 
			//socket.send("Ping\n"); 
			socket.send("connect/.../abc/");
			}
		};
		
		//Log bei Fehler
		socket.onerror = function (error){
			console.log("WebSocket Error " + error);
		};
		
		//callback-Funktion wird gerufen, wenn eine neue Websocket-Nachricht eintrifft
		socket.onmessage = function (messageEvent){
			console.log("Erhalte Nachricht von Server: " + messageEvent.data);
			//console.log("${messageEvent.data}\n");
			//socket.send(messageEvent.data.toUpperCase());
			var str = messageEvent.data;
			var res = str.split("/.../");
			//Uebermittlung der Gesamtanzahl an Clients
			if(res[0] === "anzClients"){
				anzClients = res[1];
				console.log("Anzahl an Clients: " + anzClients);
			}
			//Uebermittlung der Client-Nummer
			if(res[0] === "yourNumber"){
				myNumber = res[1];
				console.log("Ich bin Client Nr. " + myNumber);
			}
			//Uebermittlung der Groesse des zu berechnenden Anteils
			if(res[0] === "size"){
				width = res[1];
				height = res[2];
				console.log("Erhalte Groesse: " + width + "x" + height);
				var fact = factorial(width);
				console.log("Schicke Faktor von " + width + " zurueck an Server: " + fact);
				socket.send(fact.valueOf());
			}
		};
		
		
		
		socket.onclose = function(closeEvent){
			if (closeEvent.wasClean){
				console.log("Verbindung beendet, code = ${closeEvent.code}, Grund = ${closeEvent.reason}");
			}
			else{
				console.log("Verbindung abgestuertzt.");
			}
		
		}
	  </script>
   </body>
</html>